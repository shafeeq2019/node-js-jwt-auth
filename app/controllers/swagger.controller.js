const express = require("express");
const swaggerJSDoc = require('swagger-jsdoc');
const swaggerUi = require('swagger-ui-express');
const swaggerModelValidator = require('swagger-model-validator');
const Router = express.Router();


const options = {
    swaggerDefinition: {
      openapi: '3.0.1',
      info: {
        version: "1.0.0",
        title: "Customer API",
        description: "Customer API Information",
        contact: {
          name: "Amazing Developer"
        },
      },
      servers: [
        { url: 'http://localhost:8081/api/v1' , description: "Development server"}
      ],
      schemes: ["http", "https"],
      components: {
        securitySchemes: {
          bearerAuth: {
            type: "http",
            scheme: "bearer",
            bearerFormat: "JWT",
            description: ` For accessing the API a valid JWT token must be passed in all the queries in
            the 'Authorization' header.
            A valid JWT token is generated by the API and retourned as answer of a call
            to the route /login giving a valid user & password.`
          }
        },
        schemas: {
          comment: {
            type: "object",
            properties: {
              postId: {
                type: "integer"
              },
              comment: {
                type: "string"
              }
            },
            required: [
              "id",
              "comment"
            ]
          },
          post: {
            type: "object",
            properties: {
              post: {
                type: "string"
              }
            },
            required: [
              "post"
            ]
          },
          like: {
            type: "object",
            properties: {
              postId: {
                type: "integer"
              }
            },
            required: [
              "postId"
            ]
          }
        }
      },
      security: [
        { bearerAuth: [] }
      ],
    },
    // ['.routes/*.js']
    apis: ["server.js","app/routes/*.js"]
  };

const swaggerSpec = swaggerJSDoc(options);
swaggerModelValidator(swaggerSpec);

Router.get('/json', function (req, res) {
  res.setHeader('Content-Type', 'application/json');
  res.send(swaggerSpec);
});

Router.use('/', swaggerUi.serve, swaggerUi.setup(swaggerSpec));

exports.validateModel =  (name, model) => {
  const responseValidation = swaggerSpec.validateModel(
    name,
    model,
    false,
    true
  );
  if (!responseValidation.valid) {
    console.error(responseValidation.errors);
    throw new Error(`Model doesn't match Swagger contract`);
  }
}

exports.Router = Router;